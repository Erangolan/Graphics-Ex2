<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="stylesheet.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <title>Title</title>
    <style>
        body {
            text-align:center;
        }
        #menu {
            padding: 10px 10px;
            display:inline-block;
            border: 1px solid grey;
        }
        canvas {
            border: 1px solid black;
        }
        input[type=radio] {
				display:none;
				margin:10px;
			}
    </style>
</head>
<body>
    <div id="wrapper">
    <div class="card-body">
    <div class="input-group">
        <div class="custom-file">
            <input type="file" multiple="multiple" class="custom-file-input" id="inputfile" name="inputfile" aria-describedby="inputGroupFileAddon">
            <label class="custom-file-label" for="inputGroupFile">Choose file</label>
        </div>
    </div>
    <div id="menu" style="display:block">
        <button onclick="changeCurrent('move')">MOVE</button>
        <button onclick="changeCurrent('scale')">SCALE</button>
        <button onclick="changeCurrent('rotate')">ROTATE</button>
        <button onclick="changeCurrent('mirror')">MIRROR</button>
        <button onclick="changeCurrent('shear')">SHEAR</button>
        <button id="clear">CLEAR</button>
    </div>
</div>
    <div id="move" style="display:none">
        X:
        <input id="movex" type="text" value="0">
        Y:
        <input id="movey" type="text" value="0">
        <button onclick="move()">MOVE</button>
        <p>Please select the number of pixels to move (EX. 20,30)</p>
    </div>
    <div id="scale" style="display:none">
        PX:
        <input id="scalex" type="text" value="0.0">
        <button onclick="scale()">SCALE</button>
        <p>Please select the scale to increase in decimal (EX. 0.75)</p>
    </div>
    <div id="rotate" style="display:none">
        DEGREE:
        <input id="deg" type="text" value="0.2">
        <button onclick="rotate()">ROTATE</button>
        <p>Please select the amount to rotate (EX 0.1)</p>
    </div>
    <div id="mirror" style="display:none">
        <button onclick="mirrorX()">MIRROR-X</button>
        <button onclick="mirrorY()">MIRROR-Y</button>
        <p>Click the buttons to mirror the image</p>
    </div>
    <div id="shear" style="display:none">
        <p>you will be able to shear by draggin top/bottom</p>
    </div>

    <canvas id="main" width="1000px" height="800px"></canvas>
</div>
</body>
<script>
    document.getElementById("clear").addEventListener("click", clear);

    var canvas = document.getElementById("main");
    var ctx = canvas.getContext("2d");
    canvas.onmousedown = myDown;
    canvas.onmouseup = myUp;
    canvas.onmousemove = myMove;
    var currentAction = 'move';
    var datafile = [];

    document.getElementById('inputfile')
        .addEventListener('change', function(event) {
            clear();
            var fr = new FileReader();
            event.preventDefault()
            if (this.files[0].name.slice(this.files[0].name.length-4 , this.files[0].name.length) !== '.txt') {
                alert('only txt file!')
            }
            else {
                fr.onload=function() {
                fr.result.replace(' ','');
                datafile = fr.result.split('\n');
                datafile.forEach((item,i) => {
                    datafile[i] = item.split(',');
                    datafile[i].forEach((subItem,si) => {
                        if (!isNaN(subItem))
                            datafile[i][si] = Number(subItem);
                    })
                });
                    console.log(datafile);
                    draw();
                }
            }
        fr.readAsText(this.files[0]);
    })


    // Changes the current state of the app, depending on the action
    function changeCurrent (action) {
        document.getElementById(currentAction).style.display = "none";
        currentAction = action;
        document.getElementById(action).style.display = "block";
    }

    // Draws a line
    function drawline(x1,y1,x2,y2) {
        ctx.moveTo(x1,y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
    }

    // Draw a circle
    function drawCircle(x1,x2,r) {
        ctx.beginPath();
        ctx.arc(x1, x2, r, 0, 2 * Math.PI);
        ctx.stroke();
    }

    // Clears Canvas
    function clear() {
        ctx.beginPath();
        ctx.clearRect(0, 0, 1000, 800);
    }

    // Initate move sequence
    function move() {
        clear();
        var x = parseInt(document.getElementById("movex").value);
        var y = parseInt(document.getElementById("movey").value);
        drawMove(x,y);
        draw();
    }

    // Calculate move function
    function drawMove(x,y) {
        datafile = datafile.map((item) => {
            if (item[0] === 'L') {
                return ['L',item[1]+x,item[2]+y,item[3]+x,item[4]+y]
            } else if (item[0] === 'C') {
                return ['C',item[1]+x,item[2]+y,item[3]]
            } else {
                return ['B',item[1]+x,item[2]+y,item[3]+x,item[4]+y,item[5]+x,item[6]+y,item[7]+x,item[8]+y,item[9]]
            }
        });
    }

    // Scale Image
    function scale() {
        clear();
        var x = parseFloat(document.getElementById("scalex").value);
        console.log(x);
        datafile = datafile.map((item) => {
            if (item[0] === 'L') {
                return ['L',item[1]*x,item[2]*x,item[3]*x,item[4]*x]
            } else if (item[0] === 'C') {
                return ['C',item[1]*x,item[2]*x,item[3]*x]
            } else {
                return ['B',item[1]*x,item[2]*x,item[3]*x,item[4]*x,item[5]*x,item[6]*x,item[7]*x,item[8]*x,item[9]]
            }
        });
        draw();
    }

    function calcRotateX(x,y,deg) {
        return (x*Math.cos(deg)-(y*Math.sin(deg)))
    }

    function calcRotateY(x,y,deg) {
        return (x*Math.sin(deg)+(y*Math.cos(deg)))
    }

    // Rotate Image
    function rotate() {
        clear();
        var deg = parseFloat(document.getElementById("deg").value);
        datafile = datafile.map((item) => {
            if (item[0] === 'L') {
                return ['L',calcRotateX(item[1],item[2],deg),calcRotateY(item[1],item[2],deg),calcRotateX(item[3],item[4],deg),calcRotateY(item[3],item[4],deg)]
            } else if (item[0] === 'C') {
                return ['C',calcRotateX(item[1],item[2],deg),calcRotateY(item[1],item[2],deg),item[3]]
            } else {
                return ['B',
                    calcRotateX(item[1],item[2],deg),
                    calcRotateY(item[1],item[2],deg),
                    calcRotateX(item[3],item[4],deg),
                    calcRotateY(item[3],item[4],deg),
                    calcRotateX(item[5],item[6],deg),
                    calcRotateY(item[5],item[6],deg),
                    calcRotateX(item[7],item[8],deg),
                    calcRotateY(item[7],item[8],deg),
                    item[9]]
            }
        });
        draw();
    }

    // Mirror Image Horizontally
    function mirrorX() {
        clear();
        datafile = datafile.map((item) => {
            if (item[0] === 'L') {
                return ['L',-item[1],item[2],-item[3],item[4]]
            } else if (item[0] === 'C') {
                return ['C',-item[1],item[2],item[3]]
            } else {
                return ['B',-item[1],item[2],-item[3],item[4],-item[5],item[6],-item[7],item[8],item[9]]
            }
        });
        drawMove(1000,0);
        draw();
    }

    // Mirror Image Vertically
    function mirrorY() {
        clear();
        datafile = datafile.map((item) => {
            if (item[0] === 'L') {
                return ['L',item[1],-item[2],item[3],-item[4]]
            } else if (item[0] === 'C') {
                return ['C',item[1],-item[2],item[3]]
            } else {
                return ['B',item[1],-item[2],item[3],-item[4],item[5],-item[6],item[7],-item[8],item[9]]
            }
        });
        drawMove(0,800);
        draw();
    }

    // Shear Top
    function shear(a) {
        clear();
        datafile = datafile.map((item) => {
            if (item[0] === 'L') {
                return ['L',item[1] + (item[2]*a),item[2],item[3]+(item[4]*a),item[4]]
            } else if (item[0] === 'C') {
                return ['C',item[1] + (item[2]*a),item[2],item[3]]
            } else {
                return ['B',
                    item[1] + (item[2]*a),item[2],
                    item[3] + (item[4]*a),item[4],
                    item[5] + (item[6]*a),item[6],
                    item[7] + (item[8]*a),item[8],
                    item[9]
                ]
            }
        });
        draw();
    }

    // Draw the image after manipulation
    function draw() {
        datafile.forEach((item) => {
            if (item[0] === 'L') {
                drawline(item[1],item[2],item[3],item[4])
            } else if (item[0] === 'C') {
                drawCircle(item[1],item[2],item[3])
            } else {
                drawBezier(item[1],item[2],item[3],item[4],item[5],item[6],item[7],item[8],item[9])
            }
        })
    }

    var xMyDown;
    var clickActive = false;

    // On mouse click event on shear
    function myDown(e) {
        console.log('click',e.offsetY);
        if (currentAction === 'shear') {
            clickActive = true;
            if (e.offsetY < 400) {
                topbool = true;
            } else {
                topbool = false;
            }
            xMyDown = e.screenX;
        }
    }

    // On mouse drag event on shear
    function myMove(e) {
        if (currentAction === 'shear') {
            if (clickActive) {
                shear((e.screenX - xMyDown) / 50000);
            }
        }
    }

    // on mouse release event on shear
    function myUp() {
        if (currentAction === 'shear') {
            clickActive = false;
        }
    }

    var bezierMatrix = [
        [-1,3,-3,1],
        [3,-6,3,0],
        [-3,3,0,0],
        [1,0,0,0]
    ];

    function multiplyMatrices(m1, m2) {
        var result = [];
        for (var i=0; i<m1.length; i++) {
            result[i] = [];
            for (var j=0; j<m2[0].length; j++) {
                var sum = 0;
                for (var k=0; k<m1[0].length; k++) {
                    sum += m1[i][k] * m2[k][j];
                }
                result[i][j] = sum;
            }
        }
        return result;
    }

    // Draw Bezier using a bezier matrix
    function drawBezier(x0,y0,x1,y1,x2,y2,x3,y3,T) {
        var pointsMatrix = [
            [x0,y0],
            [x1,y1],
            [x2,y2],
            [x3,y3]
        ];
        var resultMatrix = multiplyMatrices(bezierMatrix,pointsMatrix);
        var currentPoint = {x:x0,y:y0};
        for (var t=0; t<1; t+=1/T) {
            var templine = {
                x: resultMatrix[0][0] * Math.pow(t,3) + resultMatrix[1][0] * Math.pow(t,2)  + resultMatrix[2][0] * Math.pow(t,1)  + resultMatrix[3][0],
                y: resultMatrix[0][1] * Math.pow(t,3) + resultMatrix[1][1] * Math.pow(t,2)  + resultMatrix[2][1] * Math.pow(t,1)  + resultMatrix[3][1],
            };
            drawline(currentPoint.x,currentPoint.y,templine.x,templine.y);
            currentPoint = {x:templine.x,y:templine.y};
        }
        var endPoint = {x:x3, y:y3};
        drawline(currentPoint.x,currentPoint.y,endPoint.x,endPoint.y);
    }


</script>
</html>
